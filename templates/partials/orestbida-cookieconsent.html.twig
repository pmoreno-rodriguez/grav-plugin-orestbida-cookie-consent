{# COOKIES CONSENT SETTINGS
   This template generates the JavaScript configuration for the Orestbida Cookie Consent banner.
   It handles layout, position, and language settings based on the plugin configuration.
#}

{% set lang = lang|default('en') %}

{# Layout and position mapping from config values to library values #}
{% set layout_map = {
    'consent': {
        'box': 'box',
        'box_inline': 'box inline',
        'inline': 'inline',
        'box_wide': 'box wide',
        'cloud': 'cloud',
        'cloud_inline': 'cloud inline',
        'bar': 'bar',
        'bar_inline': 'bar inline'
    },
    'preferences': {
        'box': 'box',
        'bar': 'bar',
        'bar_wide': 'bar wide'
    }
} %}

{% set position_map = {
    'consent': {
        'top_center': 'top center',
        'top_left': 'top left',
        'top_right': 'top right',
        'bottom_center': 'bottom center',
        'bottom_left': 'bottom left',
        'bottom_right': 'bottom right',
        'middle_center': 'middle center',
        'middle_left': 'middle left',
        'middle_right': 'middle right'
    },
    'preferences': {
        'left': 'left',
        'right': 'right'
    }
} %}

{# Get layout and position values with defaults #}
{% set c_layout = layout_map.consent[config.consent_layout] ?? 'box' %}
{% set p_layout = layout_map.preferences[config.preferences_layout] ?? 'box' %}
{% set c_position = position_map.consent[config.consent_position] ?? 'bottom right' %}
{% set p_position = position_map.preferences[config.preferences_position] ?? 'left' %}
{% set selected_categories = config.categories|default({}) %}
{% set rich_html_tags = '<a><strong><em><b><i><u><small><br><p><ul><ol><li><span>' %}

{# Define available cookie categories #}
{% set available_categories = {
    'necessary': { 'readOnly': true },
    'functionality': { 'enabled': (selected_categories.functionality ?? false) or ('functionality' in selected_categories) },
    'analytics': { 'enabled': (selected_categories.analytics ?? false) or ('analytics' in selected_categories) },
    'marketing': { 'enabled': (selected_categories.marketing ?? false) or ('marketing' in selected_categories) }
} %}

{# JavaScript configuration for cookie consent #}
CookieConsent.run({
    {# Global options #}
    autoShow: {{ config.autoshow is defined and config.autoshow ? 'true' : 'false' }},
    hideFromBots: {{ config.hideFromBots is defined and config.hideFromBots ? 'true' : 'false' }},
    disablePageInteraction: {{ config.disablePageInteraction is defined and config.disablePageInteraction ? 'true' : 'false' }},

    guiOptions: {
        consentModal: {
            layout: {{ c_layout|json_encode|raw }},
            position: {{ c_position|json_encode|raw }},
            equalWeightButtons: false,
            flipButtons: false
        },
        preferencesModal: {
            layout: {{ p_layout|json_encode|raw }},
            position: {{ p_position|json_encode|raw }},
            equalWeightButtons: false,
            flipButtons: false
        }
    },
    categories: {
        necessary: {{ available_categories.necessary|json_encode|raw }}
        {% for category, settings in available_categories %}
            {% if category != 'necessary' and settings.enabled %}
                ,{{ category }}: {}
            {% endif %}
        {% endfor %}
    },
    language: {
        default: {{ lang|json_encode|raw }},
        translations: {
            {{ lang|json_encode|raw }}: {
                consentModal: {
                    title: {{ config.consent_title|markdown|striptags(rich_html_tags)|json_encode|raw }},
                    description: {{ config.consent_description|markdown|striptags(rich_html_tags)|json_encode|raw }},
                    acceptAllBtn: {{ config.consent_acceptAllBtn|striptags|json_encode|raw }},
                    acceptNecessaryBtn: {{ config.consent_acceptNecessaryBtn|striptags|json_encode|raw }},
                    showPreferencesBtn: {{ config.consent_showPreferencesBtn|striptags|json_encode|raw }},
                    {% if config.consent_footer %}footer: {{ config.consent_footer|replace({'\\n': "\n"})|striptags(rich_html_tags)|json_encode|raw }},{% endif %}
                },
                preferencesModal: {
                    title: {{ config.preferences_title|markdown|striptags(rich_html_tags)|json_encode|raw }},
                    acceptAllBtn: {{ config.preferences_acceptAllBtn|striptags|json_encode|raw }},
                    acceptNecessaryBtn: {{ config.preferences_acceptNecessaryBtn|striptags|json_encode|raw }},
                    savePreferencesBtn: {{ config.preferences_savePreferencesBtn|striptags|json_encode|raw }},
                    closeIconLabel: "X",
                    sections: [
                        {# Usage section is always present #}
                        {
                            title: {{ config.cookies_sections.usage.title|striptags|json_encode|raw }},
                            description: {{ config.cookies_sections.usage.description|markdown|striptags(rich_html_tags)|json_encode|raw }}
                        },
                        {# Necessary category section is always present #}
                        {
                            title: {{ config.cookies_sections.necessary.title|striptags|json_encode|raw }},
                            description: {{ config.cookies_sections.necessary.description|markdown|striptags(rich_html_tags)|json_encode|raw }},
                            linkedCategory: "necessary"
                        },
                        
                        {# Generate optional category sections dynamically #}
                        {% for category, settings in available_categories %}
                            {% if category != 'necessary' and settings.enabled and config.cookies_sections[category] is defined %}
                                {
                                    title: {{ config.cookies_sections[category].title|striptags|json_encode|raw }},
                                    description: {{ config.cookies_sections[category].description|markdown|striptags(rich_html_tags)|json_encode|raw }},
                                    linkedCategory: {{ category|json_encode|raw }}
                                },
                            {% endif %}
                        {% endfor %}
                        
                        {# More info section if available #}
                        {% if config.cookies_sections.more_info.title %}
                        {
                            title: {{ config.cookies_sections.more_info.title|striptags|json_encode|raw }},
                            description: {{ config.cookies_sections.more_info.description|markdown|striptags(rich_html_tags)|json_encode|raw }}
                        }
                        {% endif %}
                    ]
                }
            }
        }
    }
});

{% set show_delay = config.show_delay|default(3000) %}

setTimeout(function() {
    CookieConsent.show();
}, {{ show_delay }});